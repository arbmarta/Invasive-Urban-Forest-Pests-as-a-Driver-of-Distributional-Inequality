import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

df = pd.read_csv(r'C:\Users\alexj\Documents\MSc Research\MSc Manuscripts\Drivers of Inequality\Python Scripts and Datasets\(1) Filtered Master Dataset.csv', low_memory=False)

# Indices
variable_columns = ['Tree Count', 'Basal Area Sum', 'DED Sus Tree Count', 'DED Sus Basal Area',
                   'DED Tree Count', 'DED Basal Area', 'EAB Tree Count', 'EAB Basal Area']
tree_count_columns = ['Tree Count', 'DED Sus Tree Count', 'DED Tree Count', 'EAB Tree Count']
basal_area_columns = ['Basal Area Sum', 'DED Sus Basal Area', 'DED Basal Area', 'EAB Basal Area']
cities = ["Calgary", "Edmonton", "Lethbridge", "Regina", "Winnipeg"]

# Aggregate information
tree_count = df['CTUID'].value_counts()
basal_area = df.groupby('CTUID')['Basal Area'].sum()

DED_Sus_tree_count = df[df['DED Susceptible'] == 0]['CTUID'].value_counts()
DED_Sus_basal_area = df[df['DED Susceptible'] == 0].groupby('CTUID')['Basal Area'].sum()

DED_tree_count = df[df['All Elm - Susceptible'] == 0]['CTUID'].value_counts()
DED_basal_area = df[df['All Elm - Susceptible'] == 0].groupby('CTUID')['Basal Area'].sum()

EAB_tree_count = df[df['EAB Susceptible'] == 0]['CTUID'].value_counts()
EAB_basal_area = df[df['EAB Susceptible'] == 0].groupby('CTUID')['Basal Area'].sum()

# Aggregate the two series
aggregate_df = pd.DataFrame({
    'Tree Count': tree_count,
    'Basal Area Sum': basal_area,
    'DED Sus Tree Count': DED_Sus_tree_count,
    'DED Sus Basal Area': DED_Sus_basal_area,
    'DED Tree Count': DED_tree_count,
    'DED Basal Area': DED_basal_area,
    'EAB Tree Count': EAB_tree_count,
    'EAB Basal Area': EAB_basal_area
}).fillna(0)

aggregate_df = aggregate_df.reset_index()

# Remove extra columns
aggregate_df = aggregate_df[['CTUID', 'Tree Count', 'Basal Area Sum', 'DED Sus Tree Count','DED Sus Basal Area',
                      'DED Tree Count', 'DED Basal Area', 'EAB Tree Count','EAB Basal Area']]

# Population counts
CTUID_df = pd.read_excel(r'C:\Users\alexj\Documents\MSc Research\MSc Manuscripts\Drivers of Inequality\Census Statistics\Census Tracts.xlsx')

Winnipeg_total_population = 749607
Regina_total_population = 226404
Lethbridge_total_population = 98406
Calgary_total_population = 1306784
Edmonton_total_population =	1010899

final_df = CTUID_df.merge(aggregate_df, how='outer', on='CTUID')

print(final_df.columns)
print(len(final_df))

# Fill NaN values with 0 for the specified columns
final_df[variable_columns] = final_df[variable_columns].fillna(0)

## CREATE LORENZ CURVES
# Loop through each city and generate Lorenz curves
for city in cities:
    # Filter the data for the current city
    city_df = final_df[final_df['City'] == city]

    if city_df.empty:
        print(f"No data available for {city}")
        continue

    # ===================== Plot for Tree Count Columns =====================
    plt.figure(figsize=(10, 6))

    for column in tree_count_columns: # Plot Lorenz curves for tree count columns on the same plot
        sorted_df = city_df.sort_values(by=column) # Sort the data by the current column in ascending order
        cumulative_column = sorted_df[column].cumsum() # Cumulative sum for the current column
        cumulative_column_normalized = cumulative_column / cumulative_column.iloc[-1]  # Normalize the cumulative sums to get values between 0 and 1
        percentiles_column = np.linspace(0, 1, len(sorted_df)) # Create an array for the percentiles (0 to 1)
        plt.plot(percentiles_column, cumulative_column_normalized, label=f'Lorenz Curve ({column})') # Plot Lorenz Curve for the current column

    plt.plot([0, 1], [0, 1], linestyle='--', color='black', label='Equality Line') # Plot the equality line (diagonal)

    # Labels and title
    plt.xlabel('Cumulative Population')
    plt.ylabel('Cumulative Share of Trees')
    plt.title(f'Lorenz Curves for Tree Counts in {city}')
    plt.legend()

    # Show the plot for Tree Count columns
    plt.show()

    # ===================== Plot for Basal Area Columns =====================
    plt.figure(figsize=(10, 6))

    for column in basal_area_columns:
        sorted_df = city_df.sort_values(by=column)
        cumulative_column = sorted_df[column].cumsum()
        cumulative_column_normalized = cumulative_column / cumulative_column.iloc[-1]
        percentiles_column = np.linspace(0, 1, len(sorted_df))
        plt.plot(percentiles_column, cumulative_column_normalized, label=f'Lorenz Curve ({column})')

    # Plot the equality line (diagonal)
    plt.plot([0, 1], [0, 1], linestyle='--', color='black', label='Equality Line')

    # Labels and title
    plt.xlabel('Cumulative Population')
    plt.ylabel('Cumulative Share of Basal Area')
    plt.title(f'Lorenz Curves for Basal Area in {city}')
    plt.legend()

    # Show the plot for Basal Area columns
    plt.show()
